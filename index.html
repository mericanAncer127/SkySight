<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-Y2E1745DBQ"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-Y2E1745DBQ');
    </script>
    <script>
        var hasPaid=false;
        var coords=null;
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Instant Roof Measurements">
    <meta name="keywords" content="Roof Measurements, Instant Roof Measurements, Roof Area Measurements">
    <title>Instant $3 Roof Measurements</title>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://npmcdn.com/@turf/turf/turf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfkit/0.12.2/pdfkit.js"></script>
    <style>
        body {
            font-family: Roboto Slab;
            background-color: #97bdd1;
            color: black;
        }
        .step-divider {
            color: black;
        }s
    </style>
</head>
<body>
    <div style="text-align: center;" class="step-divider">
        <h1>Measure any roof in the world, for just $3</h1>
    </div>

    <div style="text-align: center;">
        <a href="sample_report.pdf" download>Download Sample Report (PDF)</a>
    </div>

    <div style="text-align: center;" class="step-divider">
        <h4>Please contact skysightroofing@gmail.com with any questions or concerns</h4>
    </div>

    <div style="text-align: center; padding-bottom:10px;" class="step-divider">
        <input id="address" type="text" placeholder="Enter an address">
        <button onclick="locateAddress()">Locate Address</button>
    </div>

    <div id="map" style="left:10%; right:10%; width: 80%; height: 400px;"></div>

    <div style="text-align: center;" class="step-divider">
        <h2>Step 1: Click on the roof you want measured</h2>
    </div>

    <div style="text-align: center;" class="step-divider">
        <h2>Step 2: Make $3 payment</h2>
        <div style="display: flex; justify-content: center; align-items: center;">
            <div id="paypal-button-container"></div>
        </div>
        <script src="https://www.paypal.com/sdk/js?client-id=ARzk0dbJaLT58q39nB78HwNM9tEQslBqvrmDbrh2Ktq0Av-linppFsiMBDgoxoYzU9OZopuCnZTV5w8m"></script>
        <script>
            paypal.Buttons({
                createOrder: function(data, actions) {
                    return actions.order.create({
                        purchase_units: [{
                            amount: {
                                currency_code: 'USD',
                                value: '3.00'
                            }
                        }]
                    });
                },
                onApprove: function(data, actions) {
                    hasPaid=true;
                    return actions.order.capture().then(function(details) {
                        alert('Transaction completed by ' + details.payer.name.given_name + '!');
                    });
                }
            }).render('#paypal-button-container');

        </script>
    </div>

    <div style="text-align: center; padding-bottom:20px;">
        <h2>Step 3: Download measurements</h2>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.5.0-beta4/html2canvas.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.70/pdfmake.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.70/vfs_fonts.js"></script>
        <script src="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.js"></script>
        <link href="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.css" rel="stylesheet">
        <button onclick="generatePDF()">Download PDF</button>
    </div>

    <script>
    mapboxgl.accessToken = 'pk.eyJ1Ijoic2VjZmFzdCIsImEiOiJjanVlbGRxbTUwNGVlNDlwcXRxNnFhYnlzIn0.-dc9uxSNW4TUYbC96E8zjA';
    let currentMarker;

    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [-74.006, 40.8028],
        zoom: 15,
        preserveDrawingBuffer: true
    });

    var table_data=Array();

    map.on('load', function() {
        map.addSource('buildings', {
            type: 'vector',
            url: 'mapbox://mapbox.mapbox-streets-v8'
        });

        map.addLayer({
            'id': 'building-extrusion',
            'type': 'fill-extrusion',
            'source': 'buildings',
            'source-layer': 'building',
            'paint': {
                'fill-extrusion-color': [
                    'case',
                    ['boolean', ['feature-state', 'selected'], false],
                    '#52c765',
                    '#aaa'
                ],
                'fill-extrusion-height': {
                    'type': 'identity',
                    'property': 'height'
                }
            }
        });
        map.on('mouseenter', 'building-extrusion', function() {
            map.getCanvas().style.cursor = 'pointer';
        });

        map.on('mouseleave', 'building-extrusion', function() {
            map.getCanvas().style.cursor = '';
        });

        var selectedBuildingID = null;

        map.on('click', 'building-extrusion', function(e) {
            const feature = e.features[0];
            if (selectedBuildingID) {
                map.setFeatureState(
                    { source: 'buildings', sourceLayer: 'building', id: selectedBuildingID },
                    { selected: false }
                );
            }

            selectedBuildingID = feature.id;
            map.setFeatureState(
                { source: 'buildings', sourceLayer: 'building', id: selectedBuildingID },
                { selected: true }
            );
            if (currentMarker) {
                currentMarker.remove();
            }
            const centroid = turf.centroid(feature);
            currentMarker = new mapboxgl.Marker().setLngLat(centroid.geometry.coordinates).addTo(map);
            coords=feature._geometry.coordinates;
        });
    });

    function locateAddress() {
        const address = document.getElementById('address').value;
        fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(address)}.json?access_token=${mapboxgl.accessToken}`)
        .then(response => response.json())
        .then(data => {
            const coordinates = data.features[0].geometry.coordinates;
            if (currentMarker) {
                currentMarker.remove();
            }
            map.flyTo({ center: coordinates, zoom: 18.5});
        });
    }

    function calculatePolygonArea(points) {
        const polygon = turf.polygon(points);
        const areaM2 = turf.area(polygon);
        const areaFt2 = areaM2 * 10.7639;
        return areaFt2/100;
    }

    function createMeasurements(feature) {
        areaFt2=calculatePolygonArea(coords);
        for(let i = 0; i <= 15; i++) {
            const adjustedArea = (areaFt2 / Math.cos(Math.atan(i/12))).toFixed(1);
            table_data.push({key:i,value:adjustedArea});
        }
        return table_data;
    }

    async function generatePDF() {
        if (!hasPaid) { return; }
        const imgDataMap = map.getCanvas().toDataURL();
        const title = {
            text: 'SkySight FastSquares Report',
            alignment: 'center',
            color: 'black',
            fontSize: 22,
            margin: [10, 10, 10, 10],
        };
        var table_data=createMeasurements()
        // Create a table from the key-value pairs
        const table = {
            table: {
                widths: ['*', '*'],
                headerRows: 1,
                body: [
                    [{ text: 'Pitch', style: 'tableHeader' }, { text: 'Area (squares)', style: 'tableHeader' }],
                    ...table_data.map(item => [item.key, item.value]),
                ],
            },
            layout: 'lightHorizontalLines',
            margin: [0, 10, 0, 0], // Adjust table margins as needed
        };
        const docDefinition = {
            content: [
                title,
                {
                    image: imgDataMap,
                    width: 500,
                },
                table, // Add the table here
            ],
            styles: {
                tableHeader: {
                    bold: true,
                    fontSize: 13,
                    color: 'black',
                },
            },
        };
        pdfMake.createPdf(docDefinition).download('download.pdf');
        hasPaid=false;
    }
    </script>
</body>
</html>